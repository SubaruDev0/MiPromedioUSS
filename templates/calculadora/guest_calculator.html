{% extends 'calculadora/base.html' %}

{% block content %}
<div class="container" style="margin-top: 20px;">
    <div class="calculator-card">
        <h2 class="text-center" style="color: var(--primary-color); margin-bottom: 20px;">Calculadora Rápida</h2>

        <!-- Selector de nota objetivo -->
        <div class="input-group" style="margin-bottom: 20px;">
            <label style="font-weight: 600; margin-bottom: 8px; display: block;">¿Qué nota final quieres tener?</label>
            <select id="nota-objetivo-tipo" class="grade-input" onchange="toggleNotaObjetivoInput()" style="margin-bottom: 10px;">
                <option value="pasar">Pasar es pasar (39.5)</option>
                <option value="custom">Ingresar otra nota objetivo</option>
            </select>
            <div id="nota-objetivo-custom-container" style="display: none;">
                <input type="number" id="nota-objetivo-custom" class="grade-input" placeholder="Ingresa tu nota objetivo (10-70)" min="10" max="70" step="0.1" oninput="calculateGuest()">
            </div>
        

<script>
    function addRow() {
        const container = document.getElementById('grades-container');
        const div = document.createElement('div');
        div.className = 'grade-row';
        div.innerHTML = `
            <div class="input-group">
                <label>Nota (10-70)</label>
                <input type="number" class="grade-input" placeholder="" min="10" max="70" oninput="calculateGuest()">
            </div>
            <div class="input-group">
                <label>Porcentaje (%)</label>
                <input type="number" class="weight-input" placeholder="" min="0" max="100" oninput="calculateGuest()">
            </div>
            <button class="btn-remove" onclick="removeRow(this)"><i class="fas fa-minus"></i></button>
        `;
        container.appendChild(div);
    }

    function removeRow(btn) {
        const row = btn.closest('.grade-row');
        if (document.querySelectorAll('.grade-row').length > 1) {
            row.remove();
            calculateGuest();
        }
    }

    function clearCalculator() {
        document.querySelectorAll('.grade-input').forEach(i => i.value = '');
        document.querySelectorAll('.weight-input').forEach(i => i.value = '');
        document.getElementById('repete-section').style.display = 'none';
        document.getElementById('guest-average').innerText = '--';
        document.getElementById('guest-final-average').innerText = '--';
    }

    function calculateGuest() {
        const rows = document.querySelectorAll('.grade-row');
        let totalWeightedScore = 0;
        let totalWeight = 0;
        let grades = [];

        rows.forEach(row => {
            const gradeInput = row.querySelector('.grade-input');
            const weightInput = row.querySelector('.weight-input');

            let grade = parseFloat(gradeInput.value);
            let weight = parseFloat(weightInput.value);

            // VALIDACIONES MEJORADAS
            // Validar notas (10-70)
            if (gradeInput.value !== '') {
                if (grade > 70) { 
                    grade = 70; 
                    gradeInput.value = 70; 
                }
                // Solo aplicar mínimo si el usuario ha terminado de escribir
                if (grade < 10 && gradeInput.value.length >= 2) { 
                    grade = 10; 
                    gradeInput.value = 10; 
                }
            }

            // Validar porcentajes (0-100)
            if (weightInput.value !== '') {
                if (weight > 100) { 
                    weight = 100; 
                    weightInput.value = 100; 
                }
                if (weight < 0) { 
                    weight = 0; 
                    weightInput.value = 0; 
                }
            }

            if (!isNaN(grade) && !isNaN(weight) && grade >= 10 && weight > 0) {
                grades.push({ grade, weight });
                totalWeightedScore += grade * (weight / 100);
                totalWeight += weight;
            }
        });

        const avgDisplay = document.getElementById('guest-average');
        const finalAvgDisplay = document.getElementById('guest-final-average');
        const repeteSection = document.getElementById('repete-section');

        let currentAverage = 0;
        if (totalWeight > 0) {
            // Calculate average (scale 10-70)
            currentAverage = totalWeightedScore / (totalWeight / 100);
            avgDisplay.innerText = currentAverage.toFixed(1);
        } else {
            avgDisplay.innerText = '--';
            finalAvgDisplay.innerText = '--';
            repeteSection.style.display = 'none';
            return;
        }

        // Repete Logic
        // Trigger if total weight is approx 100% and average < 39.5
        if (totalWeight >= 99.9 && currentAverage < 39.5) {
            repeteSection.style.display = 'block';

            const repeteGradeInput = document.getElementById('repete-grade');
            let repeteGrade = parseFloat(repeteGradeInput.value);

            // VALIDAR NOTA DE REPETE (10-70)
            if (repeteGradeInput.value !== '') {
                if (repeteGrade > 70) { 
                    repeteGrade = 70; 
                    repeteGradeInput.value = 70; 
                }
                if (repeteGrade < 10 && repeteGradeInput.value.length >= 2) { 
                    repeteGrade = 10; 
                    repeteGradeInput.value = 10; 
                }
            }

            const repeteMode = document.getElementById('repete-mode').value;

            if (!isNaN(repeteGrade)) {
                let finalGrades = JSON.parse(JSON.stringify(grades)); // Deep copy

                if (repeteMode === 'lowest') {
                    // Replace lowest grade
                    let minGradeIndex = 0;
                    let minGrade = finalGrades[0].grade;

                    for (let i = 1; i < finalGrades.length; i++) {
                        if (finalGrades[i].grade < minGrade) {
                            minGrade = finalGrades[i].grade;
                            minGradeIndex = i;
                        }
                    }
                    finalGrades[minGradeIndex].grade = repeteGrade;

                } else if (repeteMode === 'highest_weight') {
                    // Replace grade with highest weight
                    let maxWeightIndex = 0;
                    let maxWeight = finalGrades[0].weight;

                    for (let i = 1; i < finalGrades.length; i++) {
                        if (finalGrades[i].weight > maxWeight) {
                            maxWeight = finalGrades[i].weight;
                            maxWeightIndex = i;
                        }
                    }
                    finalGrades[maxWeightIndex].grade = repeteGrade;
                }

                // Recalculate Final Average
                let finalWeightedScore = 0;
                let finalTotalWeight = 0;

                finalGrades.forEach(g => {
                    finalWeightedScore += g.grade * (g.weight / 100);
                    finalTotalWeight += g.weight;
                });

                let finalAverage = finalWeightedScore / (finalTotalWeight / 100);
                finalAvgDisplay.innerText = finalAverage.toFixed(1);
            } else {
                finalAvgDisplay.innerText = '--';
            }
        } else {
            repeteSection.style.display = 'none';
            finalAvgDisplay.innerText = currentAverage.toFixed(1); // Same as average if no repete needed
        }
    }
</script>
{% endblock %}