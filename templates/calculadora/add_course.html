{% extends 'calculadora/base.html' %}

{% block content %}
<div class="container" style="margin-top: 20px; padding-bottom: 100px;">
    <div class="calculator-card">
        <h2 class="text-center" style="color: var(--primary-color); margin-bottom: 20px;">Agregar Ramo</h2>

        <form method="post" id="add-course-form">
            {% csrf_token %}

            <!-- Info Básica -->
            <div class="input-group" style="margin-bottom: 20px;">
                <label>Nombre del Ramo</label>
                <input type="text" name="nombre" class="grade-input" placeholder="Ej: Programación Avanzada" required>
            </div>

            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <div class="input-group" style="flex: 1;">
                    <label>Año en el que vas</label>
                    <select name="anio_academico" class="grade-input" required>
                        {% for value, label in anio_choices %}
                        <option value="{{ value }}">{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="input-group" style="flex: 1;">
                    <label>Semestre</label>
                    <input type="number" name="semestre" class="grade-input" value="1" min="1" max="2" required>
                </div>
            </div>

            <div class="input-group" style="margin-bottom: 20px;">
                <label>Asistencia (%)</label>
                <input type="number" name="asistencia" class="grade-input" placeholder="Ej: 75" min="0" max="100">
            </div>

            <hr style="border: 0; border-top: 1px solid var(--divider-color); margin: 20px 0;">

            <h3 style="color: var(--primary-light); font-size: 1.1rem; margin-bottom: 15px;">Evaluaciones</h3>

            <div id="evaluations-container">
                <!-- Evaluaciones dinámicas aquí -->
            </div>

            <div class="actions-row" style="justify-content: center; gap: 10px; margin-top: 20px;">
                <button type="button" class="btn-secondary" onclick="addSolemne()"
                    style="font-size: 0.9rem; width: auto; padding: 10px 15px;">
                    <i class="fas fa-plus"></i> Solemne
                </button>
                <button type="button" class="btn-secondary" onclick="showTalleresModal()"
                    style="font-size: 0.9rem; width: auto; padding: 10px 15px;">
                    <i class="fas fa-layer-group"></i> Talleres
                </button>
                <button type="button" class="btn-secondary" onclick="showParcialesModal()"
                    style="font-size: 0.9rem; width: auto; padding: 10px 15px;">
                    <i class="fas fa-layer-group"></i> Parciales
                </button>
            </div>

            <button type="submit" class="btn-primary"
                style="width: 100%; border-radius: var(--radius-sm); font-size: 1rem; margin-top: 30px;">Guardar
                Ramo</button>
        </form>
    </div>
</div>

<!-- Modal Talleres -->
<div id="talleres-modal"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center;">
    <div class="calculator-card" style="width: 90%; max-width: 350px;">
        <h3 class="text-center" style="margin-bottom: 20px;">Agregar Talleres</h3>

        <div class="input-group" style="margin-bottom: 15px;">
            <label>Cantidad de Talleres</label>
            <input type="number" id="talleres-count" class="grade-input" value="3" min="1" max="10">
        </div>

        <div class="input-group" style="margin-bottom: 20px;">
            <label>Porcentaje Total (%)</label>
            <input type="number" id="talleres-total-weight" class="grade-input" value="20" min="1" max="100">
        </div>

        <div style="display: flex; gap: 10px;">
            <button type="button" class="btn-secondary" onclick="closeTalleresModal()"
                style="flex: 1;">Cancelar</button>
            <button type="button" class="btn-primary" onclick="addTalleres()"
                style="flex: 1; font-size: 1rem;">Agregar</button>
        </div>
    </div>
</div>

<!-- Modal Parciales -->
<div id="parciales-modal"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center;">
    <div class="calculator-card" style="width: 90%; max-width: 350px;">
        <h3 class="text-center" style="margin-bottom: 20px;">Agregar Parciales</h3>

        <div class="input-group" style="margin-bottom: 15px;">
            <label>Cantidad de Evaluaciones</label>
            <input type="number" id="parciales-count" class="grade-input" value="3" min="1" max="10">
        </div>

        <div class="input-group" style="margin-bottom: 20px;">
            <label>Porcentaje Total (%)</label>
            <input type="number" id="parciales-total-weight" class="grade-input" value="20" min="1" max="100">
        </div>

        <div style="display: flex; gap: 10px;">
            <button type="button" class="btn-secondary" onclick="closeParcialesModal()"
                style="flex: 1;">Cancelar</button>
            <button type="button" class="btn-primary" onclick="addParciales()"
                style="flex: 1; font-size: 1rem;">Agregar</button>
        </div>
    </div>
</div>

<script>
    let solemneCount = 0;

    function addSolemne() {
        solemneCount++;
        const container = document.getElementById('evaluations-container');
        const div = document.createElement('div');
        div.className = 'grade-row';
        div.innerHTML = `
            <div class="input-group" style="flex: 2;">
                <input type="text" name="eval_names[]" class="grade-input" value="Solemne ${solemneCount}" required>
                <input type="hidden" name="eval_types[]" value="SOLEMNE">
            </div>
            <div class="input-group" style="flex: 1;">
                <input type="number" name="eval_weights[]" class="weight-input" placeholder="%" min="0" max="100" step="0.1" required>
            </div>
            <button type="button" class="btn-remove" onclick="this.closest('.grade-row').remove()"><i class="fas fa-minus"></i></button>
        `;
        container.appendChild(div);
    }

    function showParcialesModal() {
        document.getElementById('parciales-modal').style.display = 'flex';
    }

    function closeParcialesModal() {
        document.getElementById('parciales-modal').style.display = 'none';
    }

    function showTalleresModal() {
        document.getElementById('talleres-modal').style.display = 'flex';
    }

    function closeTalleresModal() {
        document.getElementById('talleres-modal').style.display = 'none';
    }

    function addTalleres() {
        const count = parseInt(document.getElementById('talleres-count').value);
        const totalWeight = parseFloat(document.getElementById('talleres-total-weight').value);

        if (count > 0 && totalWeight > 0 && totalWeight <= 100) {
            const container = document.getElementById('evaluations-container');

            // Calcular ponderaciones distribuyendo el residuo
            const baseWeight = Math.floor((totalWeight / count) * 100) / 100;
            const remainder = Math.round((totalWeight - (baseWeight * count)) * 100) / 100;

            for (let i = 1; i <= count; i++) {
                const div = document.createElement('div');
                div.className = 'grade-row';

                // Distribuir el residuo
                let weight;
                if (i <= count - Math.round(remainder / 0.01)) {
                    weight = baseWeight.toFixed(2);
                } else {
                    weight = (baseWeight + 0.01).toFixed(2);
                }

                div.innerHTML = `
                    <div class="input-group" style="flex: 2;">
                        <input type="text" name="eval_names[]" class="grade-input" value="Taller ${i}" required>
                        <input type="hidden" name="eval_types[]" value="TALLER">
                    </div>
                    <div class="input-group" style="flex: 1;">
                        <input type="number" name="eval_weights[]" class="weight-input" value="${weight}" min="0" max="100" step="0.01" placeholder="%" required>
                    </div>
                    <button type="button" class="btn-remove" onclick="this.closest('.grade-row').remove()"><i class="fas fa-minus"></i></button>
                `;
                container.appendChild(div);
            }
            closeTalleresModal();
        } else {
            alert('Por favor ingresa valores válidos (porcentaje total debe ser entre 1 y 100)');
        }
    }

    function addParciales() {
        const count = parseInt(document.getElementById('parciales-count').value);
        const totalWeight = parseFloat(document.getElementById('parciales-total-weight').value);

        if (count > 0 && totalWeight > 0 && totalWeight <= 100) {
            const container = document.getElementById('evaluations-container');

            // Calcular ponderaciones distribuyendo el residuo
            const baseWeight = Math.floor((totalWeight / count) * 100) / 100; // 2 decimales
            const remainder = Math.round((totalWeight - (baseWeight * count)) * 100) / 100;

            for (let i = 1; i <= count; i++) {
                const div = document.createElement('div');
                div.className = 'grade-row';

                // Distribuir el residuo: últimas evaluaciones reciben el ajuste
                let weight;
                if (i <= count - Math.round(remainder / 0.01)) {
                    weight = baseWeight.toFixed(2);
                } else {
                    weight = (baseWeight + 0.01).toFixed(2);
                }

                div.innerHTML = `
                    <div class="input-group" style="flex: 2;">
                        <input type="text" name="eval_names[]" class="grade-input" value="Parcial ${i}" required>
                        <input type="hidden" name="eval_types[]" value="TALLER">
                    </div>
                    <div class="input-group" style="flex: 1;">
                        <input type="number" name="eval_weights[]" class="weight-input" value="${weight}" min="0" max="100" step="0.01" placeholder="%" required>
                    </div>
                    <button type="button" class="btn-remove" onclick="this.closest('.grade-row').remove()"><i class="fas fa-minus"></i></button>
                `;
                container.appendChild(div);
            }
            closeParcialesModal();
        } else {
            alert('Por favor ingresa valores válidos (porcentaje total debe ser entre 1 y 100)');
        }
    }

    // Validar antes de enviar el formulario
    document.getElementById('add-course-form').addEventListener('submit', function (e) {
        const weights = document.querySelectorAll('input[name="eval_weights[]"]');
        let totalWeight = 0;

        weights.forEach(input => {
            const value = parseFloat(input.value) || 0;
            totalWeight += value;
        });

        // Solo prevenir si excede 100% (no si es exactamente 100%)
        if (totalWeight > 100) {
            e.preventDefault();
            alert('La suma de los porcentajes no puede exceder 100%. Actualmente suma: ' + totalWeight.toFixed(1) + '%');
            return false;
        }

        // Advertencia si no suma 100% pero permitir continuar
        if (totalWeight < 100 && totalWeight > 0) {
            if (!confirm('La suma de porcentajes es ' + totalWeight.toFixed(1) + '% (menor a 100%). ¿Deseas continuar de todos modos?')) {
                e.preventDefault();
                return false;
            }
        }
    });
</script>
{% endblock %}